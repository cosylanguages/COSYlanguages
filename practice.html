<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COSY Dictionary</title>
    <style>
        :root { --primary: #4a90e2; --success: #27ae60; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; color: var(--dark); display: flex; flex-direction: column; align-items: center; padding: 20px; }

        /* Dashboard Container */
        .container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 500px; }
        h2 { text-align: center; color: var(--primary); }

        /* Input Styles */
        .input-group { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        input { padding: 12px; border: 2px solid #ddd; border-radius: 8px; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--primary); }
        button { padding: 12px; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; transition: 0.3s; }
        .btn-add { background: var(--primary); color: white; }
        .btn-add:hover { background: #357abd; }
        .btn-practice { background: var(--success); color: white; width: 100%; margin-top: 10px; font-size: 1.1em; }
        .io-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .btn-export { background: #f39c12; color: white; flex-grow: 1; }
        .btn-import { background: #9b59b6; color: white; flex-grow: 1; }

        .language-selector { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px; }
        .language-selector label { font-weight: bold; }
        .language-selector select { padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 1em; }

        .btn-image-add { background: #3498db; color: white; margin-top: 10px; }

        /* Image Search Modal */
        #image-search-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.95); display: none;
            flex-direction: column; align-items: center; justify-content: center; z-index: 1001;
        }
        .image-search-modal { background: white; padding: 20px; border-radius: 15px; width: 90%; max-width: 600px; text-align: center; }
        .image-search-modal input { width: 70%; }
        .image-search-modal button { width: 25%; }
        .image-results { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 20px; max-height: 300px; overflow-y: auto; }
        .image-results img { width: 100%; height: 100px; object-fit: cover; cursor: pointer; border-radius: 8px; border: 2px solid transparent; }
        .image-results img:hover, .image-results img.selected { border-color: var(--primary); }

        /* Word List */
        .word-list { margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; max-height: 200px; overflow-y: auto; }
        .word-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #fafafa; }
        .word-item .thumbnail { width: 50px; height: 40px; border-radius: 5px; object-fit: cover; margin-left: 10px; }
        .delete-btn { color: #e74c3c; cursor: pointer; font-weight: bold; }

        /* Flashcard Modal */
        #practice-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.95); display: none;
            flex-direction: column; align-items: center; justify-content: center; z-index: 1000;
        }
        .card {
            width: 300px; height: 200px; perspective: 1000px; cursor: pointer; position: relative;
        }
        .card-inner {
            position: relative; width: 100%; height: 100%; text-align: center;
            transition: transform 0.6s; transform-style: preserve-3d;
        }
        .card.flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            display: flex; align-items: center; justify-content: center;
            font-size: 28px; border-radius: 15px; color: white; padding: 20px;
            flex-direction: column;
        }
        .card-front { background: var(--primary); }
        .card-back { background: var(--success); transform: rotateY(180deg); font-size: 22px; justify-content: space-around; }
        .card-back img { max-width: 80%; max-height: 100px; border-radius: 8px; margin-bottom: 5px; }
        .controls { margin-top: 30px; display: flex; gap: 20px; }
        .btn-nav { background: white; color: var(--dark); padding: 10px 20px; }
    </style>
</head>
<body>

    <div class="container">
        <h2>COSY Vocabulary</h2>

        <div class="language-selector">
            <label for="lang-select">Word Language:</label>
            <select id="lang-select" onchange="setLanguage()">
                <option value="en-US">English</option>
                <option value="fr-FR">French</option>
                <option value="it-IT">Italian</option>
                <option value="el-GR">Greek</option>
                <option value="ru-RU">Russian</option>
            </select>
        </div>

        <div class="input-group">
            <input type="text" id="wordInput" placeholder="New word...">
            <input type="text" id="defInput" placeholder="Definition or translation...">
            <input type="text" id="exampleInput" placeholder="Example sentence...">
            <button class="btn-image-add" onclick="openImageSearch()">Add Image</button>
            <input type="hidden" id="imageUrlInput">
            <button class="btn-add" onclick="addWord()">Add to My Collection</button>
        </div>

        <button class="btn-practice" onclick="openPractice()">üî• Practice Mode</button>

        <div class="io-buttons">
            <button class="btn-export" onclick="exportVocab()">Export to File</button>
            <button class="btn-import" onclick="document.getElementById('fileInput').click()">Import from File</button>
            <input type="file" id="fileInput" onchange="importVocab(event)" accept=".json" style="display: none;">
        </div>

        <div class="word-list" id="wordList">
            </div>
    </div>

    <div id="practice-overlay">
        <div class="card" onclick="flipCard()">
            <div class="card-inner" id="cardInner">
                <div class="card-front" id="displayWord">Word</div>
                <div class="card-back" id="displayDef">Definition</div>
            </div>
        </div>
        <div class="controls">
            <button class="btn-nav" onclick="prevCard()">‚Üê Back</button>
            <button class="btn-nav" onclick="nextCard()">Next ‚Üí</button>
            <button class="btn-nav" onclick="closePractice()" style="background:#e74c3c; color:white;">Exit</button>
        </div>
    </div>

    <div id="image-search-overlay">
        <div class="image-search-modal">
            <h3>Search for an Image</h3>
            <div>
                <input type="text" id="imageSearchInput" placeholder="e.g., cat, house, apple">
                <button onclick="searchImages()">Search</button>
            </div>
            <div class="image-results" id="imageResults">
                <!-- Images will be loaded here -->
            </div>
            <button onclick="closeImageSearch()" style="margin-top: 20px; background: #e74c3c; color: white;">Close</button>
        </div>
    </div>

    <script>
        let vocab = JSON.parse(localStorage.getItem('cosy_vocab')) || [];
        let currentIndex = 0;

        function renderList() {
            const listDiv = document.getElementById('wordList');
            listDiv.innerHTML = vocab.map((item, index) => `
                <div class="word-item">
                    <span>
                        <strong>${item.word}</strong>: ${item.def}
                        ${item.example ? `<br><em style="font-size: 0.9em; color: #555;">"${item.example}"</em>` : ''}
                    </span>
                    <div>
                        ${item.imageUrl ? `<img src="${item.imageUrl}" class="thumbnail" alt="thumbnail">` : ''}
                        <span class="delete-btn" onclick="deleteWord(${index})">‚úï</span>
                    </div>
                </div>
            `).join('');
            localStorage.setItem('cosy_vocab', JSON.stringify(vocab));
        }

        function addWord() {
            const word = document.getElementById('wordInput').value;
            const def = document.getElementById('defInput').value;
            const example = document.getElementById('exampleInput').value;
            const imageUrl = document.getElementById('imageUrlInput').value;
            if(!word || !def) return alert("Fill in the word and definition fields!");

            vocab.push({word, def, example, imageUrl});
            document.getElementById('wordInput').value = '';
            document.getElementById('defInput').value = '';
            document.getElementById('exampleInput').value = '';
            document.getElementById('imageUrlInput').value = ''; // Clear the hidden input
            renderList();
        }

        function deleteWord(index) {
            vocab.splice(index, 1);
            renderList();
        }

        function exportVocab() {
            if (vocab.length === 0) return alert("Your vocabulary list is empty!");

            const vocabJson = JSON.stringify(vocab, null, 2);
            const blob = new Blob([vocabJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'cosy_vocab.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function openImageSearch() {
            document.getElementById('image-search-overlay').style.display = 'flex';
        }

        function closeImageSearch() {
            document.getElementById('image-search-overlay').style.display = 'none';
        }

        async function searchImages() {
            const searchTerm = document.getElementById('imageSearchInput').value;
            if (!searchTerm) return alert("Please enter a search term.");

            const resultsContainer = document.getElementById('imageResults');
            resultsContainer.innerHTML = '<em>Loading...</em>';

            // Unsplash Source provides random images based on a search term.
            const imageUrlBase = `https://source.unsplash.com/400x300/?${searchTerm}`;

            let imagesHtml = '';
            for (let i = 0; i < 12; i++) {
                // By adding a random string, we ensure we get a different image each time.
                const searchUrl = `${imageUrlBase}&random=${i}`;
                imagesHtml += `<img src="${searchUrl}" alt="${searchTerm}" onclick="selectImage(this, '${searchUrl}')">`;
            }
            resultsContainer.innerHTML = imagesHtml;
        }

        async function selectImage(imgElement, searchUrl) {
            // Visually mark the selected image
            const allImages = document.querySelectorAll('.image-results img');
            allImages.forEach(img => img.classList.remove('selected'));
            imgElement.classList.add('selected');

            try {
                // Fetch the image to resolve the redirect and get the permanent URL
                const response = await fetch(searchUrl);
                const permanentUrl = response.url;

                // Store the permanent URL in the hidden input
                document.getElementById('imageUrlInput').value = permanentUrl;

                // Close the modal automatically after selection
                setTimeout(closeImageSearch, 300);
            } catch (error) {
                alert("Could not fetch the selected image. Please try another one.");
                imgElement.classList.remove('selected');
            }
        }

        function importVocab(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedVocab = JSON.parse(e.target.result);
                    if (Array.isArray(importedVocab)) {
                        vocab = importedVocab;
                        renderList();
                        alert("Vocabulary imported successfully!");
                    } else {
                        alert("Invalid file format.");
                    }
                } catch (error) {
                    alert("Error reading file. Please make sure it is a valid JSON file.");
                }
            };
            reader.readAsText(file);
            event.target.value = null; // Reset file input
        }

        // Practice Mode Logic
        function openPractice() {
            if(vocab.length === 0) return alert("Add some words first!");
            document.getElementById('practice-overlay').style.display = 'flex';
            currentIndex = 0;
            updateCard();
        }

        function flipCard() {
            document.getElementById('cardInner').parentElement.classList.toggle('flipped');
            // Speech Synthesis: Speak the word when showing it
            if (!document.getElementById('cardInner').parentElement.classList.contains('flipped')) {
                speak(vocab[currentIndex].word);
            }
        }

        function updateCard() {
            const cardBack = document.getElementById('displayDef');
            const currentItem = vocab[currentIndex];

            document.getElementById('cardInner').parentElement.classList.remove('flipped');
            document.getElementById('displayWord').innerText = currentItem.word;

            // Construct the back of the card
            let backContent = '';
            if (currentItem.imageUrl) {
                backContent += `<img src="${currentItem.imageUrl}" alt="Image for ${currentItem.word}">`;
            }
            backContent += `<span>${currentItem.def}</span>`;
            if (currentItem.example) {
                backContent += `<em style="font-size: 0.6em; margin-top: 10px;">"${currentItem.example}"</em>`;
            }
            cardBack.innerHTML = backContent;

            speak(currentItem.word);
        }

        function nextCard() {
            currentIndex = (currentIndex + 1) % vocab.length;
            updateCard();
        }

        function prevCard() {
            currentIndex = (currentIndex - 1 + vocab.length) % vocab.length;
            updateCard();
        }

        function closePractice() {
            document.getElementById('practice-overlay').style.display = 'none';
        }

        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = document.getElementById('lang-select').value;
            window.speechSynthesis.speak(utterance);
        }

        function setLanguage() {
            const selectedLang = document.getElementById('lang-select').value;
            localStorage.setItem('cosy_vocab_lang', selectedLang);
        }

        // Load saved language on startup
        document.getElementById('lang-select').value = localStorage.getItem('cosy_vocab_lang') || 'en-US';
        renderList(); // Load saved words on startup
    </script>
</body>
</html>